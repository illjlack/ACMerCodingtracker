# CodingTracker 项目启动指南

## 🚀 快速开始

### 环境要求

- **Java**: JDK 17 或更高版本
- **Maven**: 3.8.0 或更高版本
- **数据库**: MySQL 8.0 或 PostgreSQL 13+
- **IDE**: IntelliJ IDEA 或 Eclipse (推荐 IntelliJ IDEA)

### 1. 项目克隆和配置

```bash
# 克隆项目
git clone <your-repository-url>
cd coding-tracker

# 进入重构后的目录
cd backend/src1
```

### 2. 数据库配置

#### MySQL配置
```sql
-- 创建数据库
CREATE DATABASE coding_tracker CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;

-- 创建用户（可选）
CREATE USER 'coding_tracker'@'localhost' IDENTIFIED BY 'your_password';
GRANT ALL PRIVILEGES ON coding_tracker.* TO 'coding_tracker'@'localhost';
FLUSH PRIVILEGES;
```

#### 配置文件设置
编辑 `src/main/resources/application.properties`:

```properties
# 数据库配置
spring.datasource.url=jdbc:mysql://localhost:3306/coding_tracker?serverTimezone=Asia/Shanghai&useUnicode=true&characterEncoding=utf8mb4
spring.datasource.username=coding_tracker
spring.datasource.password=your_password
spring.datasource.driver-class-name=com.mysql.cj.jdbc.Driver

# JPA配置
spring.jpa.hibernate.ddl-auto=update
spring.jpa.database-platform=org.hibernate.dialect.MySQL8Dialect
spring.jpa.show-sql=true
spring.jpa.properties.hibernate.format_sql=true

# JWT配置
app.jwt.secret=your-secret-key-here
app.jwt.expiration=86400000

# 文件上传配置
app.upload.avatar.dir=uploads/avatars
app.upload.avatar.base-url=http://localhost:8080
app.upload.avatar.max-size=2097152

# CORS配置
app.cors.allowed-origins=http://localhost:3000,http://127.0.0.1:3000
```

### 3. 编译和启动

```bash
# 编译项目
mvn clean compile

# 运行项目
mvn spring-boot:run

# 或者打包后运行
mvn clean package
java -jar target/coding-tracker-2.0.0.jar
```

### 4. 验证启动

启动成功后，访问以下URL验证：

- **API文档**: http://localhost:8080/swagger-ui/index.html
- **健康检查**: http://localhost:8080/actuator/health
- **API基础路径**: http://localhost:8080/api/v1

## 📋 项目架构概览

### 目录结构
```
src1/
├── main/java/com/codingtracker/
│   ├── api/                    # API层 - REST控制器
│   │   └── v1/controller/     
│   ├── core/                  # 核心业务层
│   │   ├── domain/           # 领域模型
│   │   │   ├── entity/       # 实体类
│   │   │   └── repository/   # 仓储接口
│   │   └── service/          # 业务服务
│   │       └── impl/         # 服务实现
│   ├── infrastructure/        # 基础设施层
│   │   ├── security/         # 安全组件
│   │   └── external/         # 外部服务
│   ├── shared/               # 共享层
│   │   ├── dto/              # 数据传输对象
│   │   ├── exception/        # 异常定义
│   │   ├── util/             # 工具类
│   │   └── constant/         # 常量定义
│   └── config/               # 配置类
└── main/resources/
    ├── application.properties
    └── static/
```

### 核心组件

#### 1. 实体模型
- **User**: 用户实体（聚合根）
- **UserOJ**: OJ账号实体
- **UserTag**: 用户标签实体
- **OJPlatform**: OJ平台枚举

#### 2. 服务层
- **UserService**: 用户管理服务
- **UserAuthService**: 认证服务
- **UserOJService**: OJ账号服务

#### 3. 控制器
- **AuthController**: 认证相关API
- **UserController**: 用户管理API
- **UserOJController**: OJ账号管理API

## 🔐 认证和权限

### JWT认证流程

1. **用户注册/登录** → 获取JWT令牌
2. **API请求** → 在Header中携带令牌
3. **服务端验证** → 解析用户信息和权限
4. **权限检查** → 验证操作权限

### 权限角色

- **USER**: 普通用户
- **ADMIN**: 管理员
- **SUPER_ADMIN**: 超级管理员

### API认证使用

```bash
# 1. 用户登录获取令牌
curl -X POST http://localhost:8080/api/v1/auth/login \
  -H "Content-Type: application/json" \
  -d '{
    "username": "admin",
    "password": "password123"
  }'

# 响应示例
{
  "success": true,
  "code": 200,
  "message": "登录成功",
  "data": {
    "token": "eyJhbGciOiJIUzI1NiJ9...",
    "username": "admin",
    "roles": ["SUPER_ADMIN"]
  }
}

# 2. 使用令牌访问受保护的API
curl -X GET http://localhost:8080/api/v1/users \
  -H "Authorization: Bearer eyJhbGciOiJIUzI1NiJ9..."
```

## 📚 API使用示例

### 1. 用户注册

```bash
curl -X POST http://localhost:8080/api/v1/auth/register \
  -H "Content-Type: application/json" \
  -d '{
    "username": "newuser",
    "password": "password123",
    "confirmPassword": "password123",
    "realName": "新用户",
    "email": "newuser@example.com",
    "major": "计算机科学"
  }'
```

### 2. 获取用户列表

```bash
curl -X GET "http://localhost:8080/api/v1/users?page=0&size=10" \
  -H "Authorization: Bearer <your-token>"
```

### 3. 添加OJ账号

```bash
curl -X POST http://localhost:8080/api/v1/users/1/oj-accounts \
  -H "Authorization: Bearer <your-token>" \
  -H "Content-Type: application/json" \
  -d '{
    "platform": "CODEFORCES",
    "accountName": "your_cf_username"
  }'
```

### 4. 上传头像

```bash
curl -X POST http://localhost:8080/api/v1/users/1/avatar \
  -H "Authorization: Bearer <your-token>" \
  -F "file=@avatar.jpg"
```

## 🔧 开发指南

### 1. 添加新的API端点

#### 创建请求DTO
```java
@Data
@Builder
@NoArgsConstructor
@AllArgsConstructor
public class YourRequest {
    @NotBlank(message = "字段不能为空")
    private String field;
}
```

#### 创建响应DTO
```java
@Data
@Builder
@NoArgsConstructor
@AllArgsConstructor
public class YourResponse {
    private String result;
}
```

#### 创建控制器方法
```java
@RestController
@RequestMapping("/api/v1/your-resource")
@RequiredArgsConstructor
@Slf4j
public class YourController {
    
    private final YourService yourService;
    
    @PostMapping
    @Operation(summary = "创建资源")
    public ResponseEntity<ApiResponse<YourResponse>> create(@Valid @RequestBody YourRequest request) {
        YourResponse response = yourService.create(request);
        return ResponseEntity.ok(ApiResponse.success(response, "创建成功"));
    }
}
```

### 2. 添加新的业务实体

#### 创建实体类
```java
@Entity
@Table(name = "your_table")
@Data
@Builder
@NoArgsConstructor
@AllArgsConstructor
public class YourEntity extends BaseEntity {
    
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Integer id;
    
    @Column(nullable = false)
    private String name;
}
```

#### 创建仓储接口
```java
public interface YourRepository extends JpaRepository<YourEntity, Integer> {
    Optional<YourEntity> findByName(String name);
    boolean existsByName(String name);
}
```

#### 创建服务接口和实现
```java
public interface YourService {
    YourResponse create(YourRequest request);
    Optional<YourResponse> findByName(String name);
}

@Service
@Transactional
@RequiredArgsConstructor
@Slf4j
public class YourServiceImpl implements YourService {
    
    private final YourRepository yourRepository;
    
    @Override
    public YourResponse create(YourRequest request) {
        // 业务逻辑实现
        return YourResponse.builder().build();
    }
}
```

### 3. 数据库迁移

项目使用Hibernate自动创建表结构，对于生产环境建议：

1. 设置 `spring.jpa.hibernate.ddl-auto=validate`
2. 使用Flyway或Liquibase进行数据库版本管理
3. 手动创建和维护SQL迁移脚本

## 🧪 测试

### 运行测试

```bash
# 运行所有测试
mvn test

# 运行特定测试类
mvn test -Dtest=UserServiceImplTest

# 运行集成测试
mvn test -Dtest="*IntegrationTest"

# 生成测试报告
mvn test jacoco:report
```

### 测试覆盖率

测试报告位置：`target/site/jacoco/index.html`

### API测试

可以使用以下工具进行API测试：

1. **Swagger UI**: http://localhost:8080/swagger-ui/index.html
2. **Postman**: 导入Swagger文档自动生成测试集合
3. **curl**: 使用命令行工具测试

## 📊 监控和日志

### 应用监控

项目集成了Spring Boot Actuator，提供以下监控端点：

- `/actuator/health` - 健康检查
- `/actuator/info` - 应用信息
- `/actuator/metrics` - 应用指标
- `/actuator/env` - 环境变量

### 日志配置

默认日志级别配置：
```properties
# 日志配置
logging.level.com.codingtracker=DEBUG
logging.level.org.springframework.security=DEBUG
logging.level.org.hibernate.SQL=DEBUG
logging.pattern.console=%d{yyyy-MM-dd HH:mm:ss} - %msg%n
```

### 性能监控

建议集成以下工具：
- **Micrometer** + **Prometheus** + **Grafana**
- **Spring Boot Admin**
- **APM工具** (如New Relic, AppDynamics)

## 📦 部署

### 1. 打包应用

```bash
# 创建可执行JAR
mvn clean package -DskipTests

# 构建Docker镜像
docker build -t coding-tracker:2.0.0 .
```

### 2. 环境配置

#### 开发环境
```properties
spring.profiles.active=dev
spring.jpa.hibernate.ddl-auto=update
spring.jpa.show-sql=true
```

#### 生产环境
```properties
spring.profiles.active=prod
spring.jpa.hibernate.ddl-auto=validate
spring.jpa.show-sql=false
logging.level.com.codingtracker=INFO
```

### 3. Docker部署

```dockerfile
FROM openjdk:17-jdk-slim

WORKDIR /app
COPY target/coding-tracker-2.0.0.jar app.jar

EXPOSE 8080

ENTRYPOINT ["java", "-jar", "app.jar"]
```

```bash
# 构建和运行
docker build -t coding-tracker .
docker run -p 8080:8080 -e SPRING_PROFILES_ACTIVE=prod coding-tracker
```

## 🚨 常见问题

### 1. 启动失败

**问题**: 数据库连接失败
**解决**: 检查数据库配置和连接信息

**问题**: 端口冲突
**解决**: 修改`server.port`配置或停止占用端口的进程

### 2. 认证问题

**问题**: JWT令牌无效
**解决**: 检查令牌格式和过期时间

**问题**: 权限不足
**解决**: 确认用户角色和API权限要求

### 3. API调用问题

**问题**: CORS错误
**解决**: 检查CORS配置和请求来源

**问题**: 参数验证失败
**解决**: 确认请求参数格式和验证规则

## 📞 技术支持

### 文档资源

- **API文档**: http://localhost:8080/swagger-ui/index.html
- **架构文档**: 
  - [API层说明](./main/java/com/codingtracker/api/README.md)
  - [核心业务层说明](./main/java/com/codingtracker/core/README.md)
  - [基础设施层说明](./main/java/com/codingtracker/infrastructure/README.md)
  - [共享层说明](./main/java/com/codingtracker/shared/README.md)

### 联系方式

- **项目仓库**: [GitHub Repository]
- **问题反馈**: [GitHub Issues]
- **技术讨论**: [Discussion Forum]

## 🔄 版本信息

### 当前版本: 2.0.0

**主要特性**:
- ✅ 重构为DDD四层架构
- ✅ JWT无状态认证
- ✅ RESTful API设计
- ✅ 完整的异常处理
- ✅ OpenAPI 3.0文档
- ✅ 分层架构文档

**下一版本计划**:
- 🔄 缓存集成
- 🔄 消息队列支持
- 🔄 数据分析功能
- 🔄 多租户支持

---

**注意**: 这是重构后的系统，可以直接投入使用。如需技术支持，请参考各层的详细文档或提交Issue。 