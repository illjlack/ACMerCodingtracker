# CodingTracker 架构设计文档

## 项目概述

CodingTracker 是一个基于 Spring Boot 的编程竞赛管理系统，采用领域驱动设计（DDD）和分层架构模式，提供用户管理、OJ平台集成、题目跟踪等功能。

## 架构原则

### 1. 设计原则
- **单一职责原则 (SRP)**: 每个类和方法只负责一个功能
- **开放封闭原则 (OCP)**: 对扩展开放，对修改封闭
- **依赖倒置原则 (DIP)**: 依赖抽象而不是具体实现
- **接口隔离原则 (ISP)**: 使用多个专门的接口，而不是单一的通用接口

### 2. 架构模式
- **分层架构 (Layered Architecture)**: 明确的层次划分
- **领域驱动设计 (DDD)**: 以业务领域为核心的设计方法
- **CQRS模式**: 读写分离，提高系统性能
- **RESTful API**: 标准的HTTP API设计

## 系统架构图

```
┌─────────────────────────────────────────────────────────┐
│                    Presentation Layer                   │
│  ┌─────────────────┐  ┌─────────────────┐              │
│  │   Web Frontend  │  │   Mobile App    │              │
│  │    (React)      │  │   (Optional)    │              │
│  └─────────────────┘  └─────────────────┘              │
└─────────────────────────────────────────────────────────┘
                               │
                               │ HTTP/HTTPS
                               ▼
┌─────────────────────────────────────────────────────────┐
│                    API Gateway Layer                    │
│  ┌─────────────────────────────────────────────────────┐ │
│  │              Spring Boot Application               │ │
│  └─────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────┘
                               │
                               ▼
┌─────────────────────────────────────────────────────────┐
│                    Application Layer                    │
│  ┌─────────────────┐  ┌─────────────────┐              │
│  │   API v1        │  │   API v2        │              │
│  │   Controllers   │  │   (Future)      │              │
│  └─────────────────┘  └─────────────────┘              │
└─────────────────────────────────────────────────────────┘
                               │
                               ▼
┌─────────────────────────────────────────────────────────┐
│                    Core Business Layer                  │
│  ┌─────────────────┐  ┌─────────────────┐              │
│  │   Domain        │  │    Service      │              │
│  │   Entities      │  │  Interfaces     │              │
│  └─────────────────┘  └─────────────────┘              │
│  ┌─────────────────┐  ┌─────────────────┐              │
│  │   Service       │  │   Repository    │              │
│  │ Implementations │  │  Interfaces     │              │
│  └─────────────────┘  └─────────────────┘              │
└─────────────────────────────────────────────────────────┘
                               │
                               ▼
┌─────────────────────────────────────────────────────────┐
│                 Infrastructure Layer                    │
│  ┌─────────────────┐  ┌─────────────────┐              │
│  │   Persistence   │  │    External     │              │
│  │   (JPA/MySQL)   │  │   Services      │              │
│  └─────────────────┘  └─────────────────┘              │
│  ┌─────────────────┐  ┌─────────────────┐              │
│  │    Security     │  │    Messaging    │              │
│  │   (JWT/Auth)    │  │   (Optional)    │              │
│  └─────────────────┘  └─────────────────┘              │
└─────────────────────────────────────────────────────────┘
```

## 目录结构

### 重构后的目录结构 (src1)

```
src1/
├── main/
│   ├── java/
│   │   └── com/
│   │       └── codingtracker/
│   │           ├── CodingTrackerApplication.java
│   │           ├── api/                          # API层
│   │           │   └── v1/
│   │           │       ├── controller/           # REST控制器
│   │           │       │   ├── UserController.java
│   │           │       │   ├── AuthController.java
│   │           │       │   ├── OJController.java
│   │           │       │   └── AdminController.java
│   │           │       └── dto/                  # API专用DTO
│   │           ├── core/                         # 核心业务层
│   │           │   ├── domain/                   # 领域层
│   │           │   │   ├── entity/               # 实体类
│   │           │   │   │   ├── User.java
│   │           │   │   │   ├── UserOJ.java
│   │           │   │   │   ├── UserTag.java
│   │           │   │   │   └── OJPlatform.java
│   │           │   │   └── repository/           # 仓储接口
│   │           │   │       ├── UserRepository.java
│   │           │   │       ├── UserOJRepository.java
│   │           │   │       └── UserTagRepository.java
│   │           │   └── service/                  # 服务层
│   │           │       ├── UserService.java
│   │           │       ├── UserAuthService.java
│   │           │       ├── UserOJService.java
│   │           │       └── impl/                 # 服务实现
│   │           │           ├── UserServiceImpl.java
│   │           │           ├── UserAuthServiceImpl.java
│   │           │           └── UserOJServiceImpl.java
│   │           ├── infrastructure/               # 基础设施层
│   │           │   ├── persistence/              # 数据持久化
│   │           │   │   ├── UserRepositoryImpl.java
│   │           │   │   └── mapper/
│   │           │   ├── external/                 # 外部服务集成
│   │           │   │   ├── oj/
│   │           │   │   │   ├── CodeforcesAdapter.java
│   │           │   │   │   └── LeetCodeAdapter.java
│   │           │   │   └── email/
│   │           │   └── security/                 # 安全相关
│   │           │       ├── JwtTokenProvider.java
│   │           │       ├── SecurityConfig.java
│   │           │       └── UserDetailsServiceImpl.java
│   │           ├── shared/                       # 共享组件
│   │           │   ├── dto/                      # 数据传输对象
│   │           │   │   ├── request/
│   │           │   │   │   ├── UserCreateRequest.java
│   │           │   │   │   ├── UserUpdateRequest.java
│   │           │   │   │   └── LoginRequest.java
│   │           │   │   └── response/
│   │           │   │       ├── UserResponse.java
│   │           │   │       ├── AuthResponse.java
│   │           │   │       └── ApiResponse.java
│   │           │   ├── exception/                # 异常处理
│   │           │   │   ├── BusinessException.java
│   │           │   │   ├── ValidationException.java
│   │           │   │   └── GlobalExceptionHandler.java
│   │           │   ├── util/                     # 工具类
│   │           │   │   ├── DateUtils.java
│   │           │   │   ├── ValidationUtils.java
│   │           │   │   └── PasswordUtils.java
│   │           │   └── constant/                 # 常量定义
│   │           │       ├── ApiConstants.java
│   │           │       └── ValidationConstants.java
│   │           └── config/                       # 配置类
│   │               ├── DatabaseConfig.java
│   │               ├── SecurityConfig.java
│   │               ├── SwaggerConfig.java
│   │               └── WebConfig.java
│   └── resources/
│       ├── application.properties
│       ├── application-dev.properties
│       ├── application-prod.properties
│       └── static/
└── test/
    └── java/
        └── com/
            └── codingtracker/
                ├── unit/                         # 单元测试
                ├── integration/                  # 集成测试
                └── e2e/                          # 端到端测试
```

## 层次架构详解

### 1. API层 (api)
**职责**: 处理HTTP请求，数据验证，响应格式化
- **Controller**: REST API端点定义
- **DTO**: API数据传输对象
- **Validation**: 请求参数验证

**特点**:
- 版本化API设计 (v1, v2...)
- 统一的响应格式
- 完整的OpenAPI文档
- 权限控制注解

### 2. 核心业务层 (core)
**职责**: 核心业务逻辑，领域模型

#### 2.1 领域层 (domain)
- **Entity**: 领域实体，包含业务逻辑
- **Repository**: 数据访问接口定义
- **Value Object**: 值对象
- **Domain Service**: 领域服务

#### 2.2 服务层 (service)
- **Service Interface**: 业务服务接口
- **Service Implementation**: 业务逻辑实现
- **Application Service**: 应用服务，协调领域对象

### 3. 基础设施层 (infrastructure)
**职责**: 技术实现，外部集成

#### 3.1 数据持久化 (persistence)
- **Repository Implementation**: 仓储接口实现
- **Data Mapper**: 数据映射
- **Database Configuration**: 数据库配置

#### 3.2 外部服务 (external)
- **OJ Platform Adapters**: OJ平台适配器
- **Email Service**: 邮件服务
- **File Storage**: 文件存储服务

#### 3.3 安全 (security)
- **Authentication**: 身份认证
- **Authorization**: 权限控制
- **JWT Token Management**: JWT令牌管理

### 4. 共享层 (shared)
**职责**: 通用组件，跨层复用
- **DTO**: 数据传输对象
- **Exception**: 异常定义和处理
- **Util**: 工具类
- **Constant**: 常量定义

## 关键设计模式

### 1. 仓储模式 (Repository Pattern)
```java
// 接口定义
public interface UserRepository extends JpaRepository<User, Integer> {
    Optional<User> findByUsername(String username);
    List<User> findByRolesContains(User.Type role);
}

// 使用
@Service
public class UserServiceImpl implements UserService {
    private final UserRepository userRepository;
    
    public Optional<UserResponse> findByUsername(String username) {
        return userRepository.findByUsername(username)
                .map(this::convertToResponse);
    }
}
```

### 2. 策略模式 (Strategy Pattern)
```java
// OJ平台适配器策略
public interface OJAdapter {
    boolean supports(OJPlatform platform);
    UserStatistics fetchUserStats(String username);
}

@Component
public class CodeforcesAdapter implements OJAdapter {
    public boolean supports(OJPlatform platform) {
        return platform == OJPlatform.CODEFORCES;
    }
    
    public UserStatistics fetchUserStats(String username) {
        // Codeforces API调用实现
    }
}
```

### 3. 工厂模式 (Factory Pattern)
```java
@Component
public class OJAdapterFactory {
    private final List<OJAdapter> adapters;
    
    public OJAdapter getAdapter(OJPlatform platform) {
        return adapters.stream()
                .filter(adapter -> adapter.supports(platform))
                .findFirst()
                .orElseThrow(() -> new UnsupportedPlatformException(platform));
    }
}
```

### 4. 建造者模式 (Builder Pattern)
```java
@Builder
public class UserResponse {
    private Integer id;
    private String username;
    private String realName;
    // ...
    
    public static UserResponse from(User user) {
        return UserResponse.builder()
                .id(user.getId())
                .username(user.getUsername())
                .realName(user.getRealName())
                .build();
    }
}
```

## 数据流设计

### 1. 请求处理流程
```
Client Request
    ↓
Controller (API Layer)
    ↓ (DTO Validation)
Service Interface (Core Layer)
    ↓ (Business Logic)
Service Implementation
    ↓ (Domain Logic)
Repository Interface
    ↓ (Data Access)
Repository Implementation (Infrastructure Layer)
    ↓ (Database Query)
Database
```

### 2. 响应处理流程
```
Database Result
    ↓
Repository Implementation
    ↓ (Entity Mapping)
Service Implementation
    ↓ (Business Processing)
Service Interface
    ↓ (Response DTO)
Controller
    ↓ (HTTP Response)
Client Response
```

## 异常处理策略

### 1. 异常层次结构
```java
// 基础业务异常
public abstract class BusinessException extends RuntimeException {
    private final String errorCode;
    private final int httpStatus;
}

// 具体业务异常
public class UserNotFoundException extends BusinessException {
    public UserNotFoundException(Integer userId) {
        super("用户不存在: " + userId, "USER_NOT_FOUND", 404);
    }
}

public class ValidationException extends BusinessException {
    public ValidationException(String message) {
        super(message, "VALIDATION_FAILED", 400);
    }
}
```

### 2. 全局异常处理
```java
@RestControllerAdvice
public class GlobalExceptionHandler {
    
    @ExceptionHandler(BusinessException.class)
    public ResponseEntity<ApiResponse<Void>> handleBusinessException(BusinessException e) {
        return ResponseEntity
                .status(e.getHttpStatus())
                .body(ApiResponse.error(e.getMessage(), e.getHttpStatus()));
    }
    
    @ExceptionHandler(ValidationException.class)
    public ResponseEntity<ApiResponse<Void>> handleValidation(ValidationException e) {
        return ResponseEntity
                .badRequest()
                .body(ApiResponse.error(e.getMessage(), 400));
    }
}
```

## 安全设计

### 1. 认证机制
- **JWT Token**: 无状态身份认证
- **Refresh Token**: 长期有效的刷新令牌
- **Token BlackList**: 已注销令牌黑名单

### 2. 权限控制
```java
// 方法级权限控制
@PreAuthorize("hasRole('ADMIN') or @userSecurityService.canEditUser(authentication.name, #userId)")
public UserResponse updateUser(Integer userId, UserUpdateRequest request) {
    // 实现
}

// 自定义权限服务
@Service
public class UserSecurityService {
    public boolean canEditUser(String currentUsername, Integer targetUserId) {
        // 权限检查逻辑
    }
}
```

### 3. 数据安全
- **密码加密**: BCrypt哈希算法
- **敏感信息**: 数据库字段加密
- **SQL注入防护**: JPA参数化查询

## 性能优化策略

### 1. 数据库优化
- **索引设计**: 基于查询模式的索引优化
- **懒加载**: JPA实体关联的懒加载
- **查询优化**: 减少N+1查询问题

### 2. 缓存策略
```java
// 用户信息缓存
@Service
public class UserServiceImpl implements UserService {
    
    @Cacheable(value = "users", key = "#username")
    public Optional<UserResponse> findByUsername(String username) {
        // 实现
    }
    
    @CacheEvict(value = "users", key = "#username")
    public void updateUser(String username, UserUpdateRequest request) {
        // 实现
    }
}
```

### 3. 异步处理
```java
// 异步OJ数据同步
@Service
public class OJSyncService {
    
    @Async
    @Retryable(value = {Exception.class}, maxAttempts = 3)
    public CompletableFuture<Void> syncUserData(String username, OJPlatform platform) {
        // 异步同步实现
        return CompletableFuture.completedFuture(null);
    }
}
```

## 测试策略

### 1. 测试金字塔
- **单元测试**: 70% - 测试个别方法和类
- **集成测试**: 20% - 测试组件间交互
- **端到端测试**: 10% - 测试完整业务流程

### 2. 测试分类
```java
// 单元测试
@ExtendWith(MockitoExtension.class)
class UserServiceImplTest {
    @Mock private UserRepository userRepository;
    @InjectMocks private UserServiceImpl userService;
    
    @Test
    void shouldFindUserByUsername() {
        // 测试实现
    }
}

// 集成测试
@SpringBootTest
@Transactional
class UserControllerIntegrationTest {
    @Autowired private TestRestTemplate restTemplate;
    
    @Test
    void shouldCreateUser() {
        // 集成测试实现
    }
}
```

## 部署架构

### 1. 开发环境
- **本地开发**: Spring Boot + MySQL
- **容器化**: Docker + Docker Compose

### 2. 生产环境
- **应用部署**: Kubernetes
- **数据库**: MySQL集群
- **负载均衡**: Nginx
- **监控**: Prometheus + Grafana

## 扩展性设计

### 1. 水平扩展
- **无状态设计**: 支持多实例部署
- **数据库分片**: 支持数据水平分割
- **缓存集群**: Redis集群支持

### 2. 功能扩展
- **插件架构**: OJ平台适配器可插拔
- **API版本化**: 支持多版本并存
- **微服务拆分**: 可拆分为独立微服务

## 监控和日志

### 1. 日志策略
```java
// 结构化日志
@Slf4j
@Service
public class UserServiceImpl implements UserService {
    
    public UserResponse createUser(UserCreateRequest request) {
        log.info("Creating user: username={}, email={}", 
                request.getUsername(), request.getEmail());
        
        try {
            // 业务逻辑
            log.info("User created successfully: userId={}", user.getId());
            return response;
        } catch (Exception e) {
            log.error("Failed to create user: username={}, error={}", 
                    request.getUsername(), e.getMessage(), e);
            throw e;
        }
    }
}
```

### 2. 监控指标
- **业务指标**: 用户注册数、活跃用户数
- **性能指标**: 响应时间、吞吐量
- **错误指标**: 错误率、异常统计

## 总结

CodingTracker 2.0 采用了现代化的架构设计，具有以下优势：

1. **清晰的职责分离**: 每一层都有明确的职责
2. **高可维护性**: 代码结构清晰，易于理解和修改
3. **良好的扩展性**: 支持功能扩展和性能扩展
4. **完整的测试覆盖**: 保证代码质量和稳定性
5. **标准的API设计**: 符合RESTful规范
6. **强大的安全机制**: 多层次的安全保障

这种架构设计为项目的长期发展和维护提供了坚实的基础。 